<!doctype html>
<html dir="rtl" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="bootstrap/bootstrap.min.css" crossorigin="anonymous">
    <script src="https://kit.fontawesome.com/7c906e4b4a.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="./panelPage/customer/Customer.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.8.0/dist/leaflet.css" integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ==" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js" integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ==" crossorigin=""></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"></script>

    <style>

        .star-rating-container {
            font-family: icomoon,serif;
            font-size: 50px;
            color: #ffbe00;
            position: relative;
            display: inline-block;
        }

        .star-rating-container.result {
            color: #ff4d30;
        }

        .star-rating-on {
            cursor: pointer;
            position: relative;
            z-index: 10;
            overflow: hidden;
            white-space: nowrap;
        }

        .star-rating-off {
            cursor: pointer;
            position: absolute;
            top: 0;
            left: 0;
            color: #eee;
        }

        .star-rating-container.result .star-rating-off {
            color: dimgrey;
        }

    </style>



</head>
<body>

<nav class="navbar navbar-expand-lg flex-column navbar-light trans ">
    <div class="container">
        <i class="fas fa-user-edit fa-5x text-warning" ></i>
        <div class="row align-content-start">
            <div >
                <a href="http://localhost:8080/logout" class="fas fa-sign-out-alt fa-3x text-warning"></a>
            </div>
        </div>
    </div>
</nav>

<div class="tab float-right ">
    <button class="tabLinks btn btn-block py-4 text-center w-100" onclick="openDiv(event, 'select')" id="defaultOpen">گزینه ها</button>
    <button class="tabLinks btn btn-block py-4 text-center w-100" onclick="openDiv(event, 'placeAnOrder')"  >ثبت سفارش</button>
    <button id="showOfferButton" class="tabLinks btn btn-block py-4 text-center w-100" onclick="openDiv(event, 'viewOffer')">مشاهده پیشنهادات</button>
    <button id="showStartedOrderButton" class="tabLinks btn btn-block py-4 text-center w-100" onclick="openDiv(event, 'doneOrder')">گزارش اتمام سفارش</button>
    <button id="OrderForPayButton" class="tabLinks btn btn-block py-4 text-center w-100" onclick="openDiv(event, 'payOrder')">پرداخت هزینه سفارش</button>
    <button id="placeACommentButton" class="tabLinks btn btn-block py-4 text-center w-100" onclick="openDiv(event, 'placeAComment')">ثبت نظر</button>
    <button class="tabLinks btn btn-block py-4 text-center w-100" onclick="openDiv(event, 'orderHistory')">تاریخچه سفارشات</button>
    <button class="tabLinks btn btn-block py-4 text-center w-100" onclick="openDiv(event, 'changePassword')">تعویض رمز</button>
</div>

<!------>
<div id="select" class="tabContent text-center " style="font-size: 30px">
    <h1 class="mt-5">پنل مشتری</h1>
    <p>به پنل مشتری خوش آمدید</p>
</div>

<!------>
<div id="placeAnOrder" class="tabContent text-center " style="font-size: 20px">

    <div>
        <label for="placeAnOrderService">
            <select id="placeAnOrderService" name="placeAnOrder" class="form-select ml-5 w-100 ">
                <option class="text-center ">لطفا سرویس را انتخاب کنید</option>
            </select>
        </label>
        <label for="placeAnOrderSubService">
            <select id="placeAnOrderSubService" name="placeAnOrder" class="form-select mr-5 w-100 form-select-lg  mt-5">
                <option class="text-center ">لطفا زیر سرویس را انتخاب کنید</option>
            </select>
        </label>
    </div>
    <div>
        <label for="proposedPriceForOrder"><br>
            <input class="rounded-pill border-0 p-lg-5 " id="proposedPriceForOrder" pattern="^[0-9]" name="minimalPrice"
                   title="enter positive number" type="text" placeholder="قیمت پیشنهادی" required><br>
        </label>
        <label for="descriptionForOrder"><br>
            <input class="rounded-pill mr-5 border-0 p-lg-5 " id="descriptionForOrder" name="descriptionForOrder"
                   title="enter a correct description" type="text" placeholder="توضیحات" required><br>
        </label>
    </div>
    <div>
        <label for="workDateForOrder"><br>
            <input class="rounded-pill border-0 p-lg-5 " id="workDateForOrder" name="workDataForOrder" type="date"
                   placeholder="تاریخ انجام کار" required><br>
        </label>
        <label for="cityForOrder"><br>
            <input style="margin-left: -10px;margin-right: 200px" class="rounded-pill border-0 p-lg-5 " id="cityForOrder" name="cityForOrder"
                   title="enter city for your order" type="text" placeholder="شهر" required><br>
        </label>
    </div>
    <div>
        <label for="streetForOrder"><br>
            <input class="rounded-pill border-0 p-lg-5 " id="streetForOrder" name="streetForOrder"
                   title="enter street for your order" type="text" placeholder="خیابان"><br>
        </label>
        <label for="alleyForOrder"><br>
            <input class="rounded-pill mr-5 border-0 p-lg-5 " id="alleyForOrder" name="alleyForOrder"
                   title="enter alley for your order" type="text" placeholder="کوچه" required><br>
        </label>
    </div>
    <label>
        <input type="text" id="subServicesId" hidden>
    </label>
    <div>
        <label for="houseNumberForOrder"><br>
            <input style="margin-right: -450px" class="rounded-pill border-0 p-lg-5 " id="houseNumberForOrder" pattern="^[0-9]"
                   title="enter house number for your order" type="text" placeholder="شماره" required><br>
        </label>

        <a href="#viewMap" class='fas btn fa-search-location fa-3x'></a>
        <button class=" mr-5 rounded-pill btn btn-info p-lg-5 font-italic font-weight-bold submit"
                id="submitPlaceAnOrder">ثبت
        </button>
    </div>
    <div id="mapDiv" style="width: 600px; height: 400px" class=" mt-5  bg-secondary"></div>
    <footer id="viewMap"></footer>
</div>
<!------>
<div id="viewOffer" class="tabContent text-center " style="font-size: 30px">
    <table id="tableOrderForCustomer" class="table container table-bordered border-primary">
        <thead>
        <tr>
            <th>شناسه</th>
            <th>قیمت پیشنهادی</th>
            <th>توضیح</th>
            <th>تاریخ</th>
            <th>آدرس</th>
            <th >انتخاب</th>
        </tr>
        </thead>
        <tbody id="TableOrderRowForCustomer">
        </tbody>
    </table>
    <div class="modal" id="modalSelectAnOffer" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content ">
                <div class="modal-header ">
                    <h4 class="modal-title text-center " id="myModalLabel">لطفا پیشنهاد مورد قبول خود را انتخاب کنید</h4>
                </div>
                <div class="modal-body">
                    <table id="tableOfferForCustomer" class="table container table-bordered border-primary">
                        <thead>
                        <tr>
                            <th>شناسه</th>
                            <th>قیمت پیشنهادی</th>
                            <th>مدت زمان تقریبی</th>
                            <th>ساعت شروع</th>
                            <th >انتخاب</th>
                        </tr>
                        </thead>
                        <tbody id="TableOfferRowForCustomer">
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" id="closeModalSelectAnOffer" class="btn btn-default btn-danger" data-dismiss="modal">بستن</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!------>
<div id="doneOrder" class="tabContent text-center " style="font-size: 30px">
    <table id="tableStartedOrderForCustomer" class="table container table-bordered border-primary">
        <thead>
        <tr>
            <th>شناسه</th>
            <th>قیمت پیشنهادی</th>
            <th>توضیح</th>
            <th>تاریخ</th>
            <th>آدرس</th>
            <th >انتخاب</th>
        </tr>
        </thead>
        <tbody id="TableStartedOrderRowForCustomer">
        </tbody>
    </table>
</div>
<!------>
<div id="payOrder" class="tabContent text-center " style="font-size: 30px">
    <table id="tableOrderForPay" class="table container table-bordered border-primary">
        <thead>
        <tr>
            <th>شناسه</th>
            <th>قیمت پیشنهادی متخصص</th>
            <th>توضیح</th>
            <th>تاریخ</th>
            <th>آدرس</th>
            <th >پرداخت از اعتبار</th>
            <th >پرداخت آنلاین</th>
        </tr>
        </thead>
        <tbody id="TableOrderRowForPay">
        </tbody>
    </table>
    <label>
        <input hidden class="rounded-pill mr-5 border-0 p-lg-5 " type="text" id="price">
    </label>
</div>
<!------>
<div id="placeAComment" class="tabContent text-center " style="font-size: 30px">
    <table id="tableOrderForComment" class="table container table-bordered border-primary">
        <thead>
        <tr>
            <th>شناسه</th>
            <th>قیمت</th>
            <th>توضیح</th>
            <th>تاریخ</th>
            <th>آدرس</th>
            <th >ثبت نظر</th>
        </tr>
        </thead>
        <tbody id="TableOrderRowForComment">
        </tbody>
    </table>
    <div class="modal" id="modalPlaceAComment" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content ">
                <div class="modal-header ">
                    <h4 class="modal-title text-center " >لطفا امتیاز و نظر خود را در صورت تمایل اضافه نمایید</h4>
                </div>
                <div class="modal-body">
                    <label hidden  for="orderIdInputComment">
                        <input hidden id="orderIdInputComment" class="form-control d-lg-block" type="text">
                    </label>
                    <label hidden for="stars">
                        <input hidden id="stars" class="form-control" type="text">
                    </label>
                    <div dir="ltr" class="star-rating-container enter">
                        <div class="star-rating star-rating-on" style="width:0;">&#9733;&#9733;&#9733;&#9733;&#9733;</div>
                        <div class="star-rating star-rating-off">&#9734;&#9734;&#9734;&#9734;&#9734;</div>
                    </div>
                    <br>
                    <label for="textCommentInput">
                        <textarea class="form-control d-block" id="textCommentInput" placeholder="در صورت تمایل نظر خود را وارد کنید" cols="30" rows="5"></textarea>
                    </label>
                </div>
                <div class="modal-footer ">
                    <button type="button" id="submitPlaceACommentButton" class="btn btn-default btn-lg btn-info" >ثبت</button>
                    <button type="button" id="closeModalPlaceAComment" class="btn btn-default btn-lg btn-danger" data-dismiss="modal">بستن</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!------>
<div id="orderHistory" class="tabContent text-center " style="font-size: 30px">
</div>
<!------>
<div id="changePassword" class="tabContent text-center " style="font-size: 30px">
</div>
<!------>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script>

    let map = L.map('mapDiv').setView([30, 56], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);


    map.on('click', function(e) {
        doStuff(e);
    });


    function doStuff(e) {
        const far = e.latlng;
        const x = e.layerPoint.x;
        const y = e.layerPoint.y;
        $("#lat").val(x);
        $("#tal").val(y);
        console.log([x, y]);

        const pointXY = L.point(x, y);
        console.log("Point in x,y space: " + pointXY);

        const pointLatLng = map.layerPointToLatLng(pointXY);
        console.log("Point in lat,lng space: " + pointLatLng);
        let location = pointLatLng;

        location = location.toString().replace(/[a-zA-Z() ]+/g,"");

        let latLocation = location.toString().split(',')[0];
        let lonLocation = location.toString().split(',')[1];

        obtainAddress(latLocation,lonLocation);

    }

    $(".enter").mousemove(function () {
        const elWidth = 250;

        const position = event.pageX - $(this).offset().left;
        let percent = Math.round((position / elWidth) * 100);
        while (true) {
            if (percent % 20 !== 0)
                percent++;
            else
                break;
        }
        $(".enter .star-rating-on").css({width: percent + "%"})
    })

    $(".enter").click(function() {
        const elWidth = 250;
        let position = event.pageX - $(this).offset().left;
        if(position > 0 && position < 45 )
            position = 1;
        if(position > 45 && position < 90 )
            position = 2;
        if(position > 90 && position < 135 )
            position = 3;
        if(position > 135 && position < 180 )
            position = 4;
        if(position > 180 && position < 225 )
            position = 5;
        $("#stars").val(position)
    })

        function obtainAddress(latLocation,lonLocation){
        $.ajax({
            url:`https://map.ir/reverse/fast-reverse/?lat=${latLocation}&lon=${lonLocation}`,
            beforeSend: function(request) {
                request.setRequestHeader('x-api-key', 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6IjcwMmMyMGMzZTk4MzZjMzQzYTk4NjNmYzcwMDNlOWE1ZDhjZDQyOTczYjU0MTJhNjFkMTcxMDRlMTNlZmZkMWI2OTk5NTEyZDY4MWIwMmQ4In0.eyJhdWQiOiIxODIzOSIsImp0aSI6IjcwMmMyMGMzZTk4MzZjMzQzYTk4NjNmYzcwMDNlOWE1ZDhjZDQyOTczYjU0MTJhNjFkMTcxMDRlMTNlZmZkMWI2OTk5NTEyZDY4MWIwMmQ4IiwiaWF0IjoxNjU0NjIwNjk2LCJuYmYiOjE2NTQ2MjA2OTYsImV4cCI6MTY1NzEyNjI5Niwic3ViIjoiIiwic2NvcGVzIjpbImJhc2ljIl19.tNI6qo9c6bK8kjdIgbInX7k2p2wBX9JrOyRs2idEVMcVpI0ltvJhoaLC4SQSUzqssyoYSUtDjcIDy3ANN4W__0MVvyIAryqJE5dRiCxCpuTIoi8elBvbUbsptF5-GDdZczmgcUHB1uaDW9doFYDHBtEFZR_7Ir-VTSwQc-sZ84GRhcYnlAKNinV-bh0fbmnKJnRra8DpyXHYYp-IkUEFiJQCz0BXWwcwuvdx76dBphBQwQjcW51mtNKfqL0n3ubqkqJdPL8-YuGRx0Sw3CzaCvhk5sHPyyWVb5Zl5FehGwgurnQJWvdNY7gWUT9sOB-Js4GbLaQJuKafA0eIt6FGQw');
                request.setRequestHeader('content-type', 'application/json');
            },
            type:'GET',
            success:function (data){
                alert(data.address)
                $("#cityForOrder").val(data.address.split('، ')[2])
                $("#streetForOrder").val(data.address.split('، ')[6])
            },error:function (result){
                Swal.fire({
                    title:"Error",
                    text:result.responseText,
                    confirmButtonText: 'close',
                })
            }
        })
    }

    function openDiv(evt, divName) {
        let i, tabContent, tabLinks;
        tabContent = document.getElementsByClassName("tabContent");
        for (i = 0; i < tabContent.length; i++) {
            tabContent[i].style.display = "none";
        }
        tabLinks = document.getElementsByClassName("tabLinks");
        for (i = 0; i < tabLinks.length; i++) {
            tabLinks[i].className = tabLinks[i].className.replace(" active", "");
        }
        document.getElementById(divName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    $("#placeAnOrderService").one('click', function () {
        $.ajax({
            url: "http://localhost:8080/services/getAllServices",
            type: "GET",
            dataType: "json",
            success: function (result) {
                let toAppend = '';
                $.each(result, function (i, o) {
                    toAppend += '<option>' + o.id + " " + o.services + '</option>';
                });
                $('#placeAnOrderService').append(toAppend);

                $("#placeAnOrderService").change(function () {
                    $('#placeAnOrderSubService')
                        .find('option')
                        .remove()
                        .end()
                        .append('<option >لطفا زیر سرویس را انتخاب کنید</option>')
                    if ($(this).val() !== "یک سرویس انتخاب کنید") {
                        $.ajax({
                            url: "http://localhost:8080/subServices/getAllSubServices/" + $(this).val()[0],
                            type: "GET",
                            dataType: "json",
                            success: function (result) {
                                let toAppend = '';
                                $.each(result, function (i, o) {
                                    toAppend += '<option>' + o.id + " " + o.subServicesName + " " + o.minimalPrice + '</option>';
                                });
                                $('#placeAnOrderSubService').append(toAppend);

                                $("#placeAnOrderSubService").change(function () {
                                    if ($(this).val() !== "لطفا زیر سرویس را انتخاب کنید") {
                                        $("#proposedPriceForOrder").attr("placeholder", "حداقل قیمت پیشنهادی " + $(this).val().split(' ')[2]);
                                        $("#subServicesId").val($(this).val()[0] + " " + $(this).val().split(' ')[2] )
                                    }
                                });
                            }
                        });
                    }
                });
            },
        });
    });

    $("#submitPlaceAnOrder").on('click',function() {
        let value = $("#subServicesId").val();
        let subServicesId = value.split(' ')[0];
        if(subServicesId === ""){
            Swal.fire({
                title: 'لطفا یک سرویس انتخاب کنید',
                confirmButtonText: 'بستن',
            });
            return;
        }
        let json = {
            "id":subServicesId,
            "proposedPrice":$("#proposedPriceForOrder").val() ,
            "description":$("#descriptionForOrder").val() ,
            "date":$("#workDateForOrder").val() ,
            "city":$("#cityForOrder").val() ,
            "street":$("#streetForOrder").val() ,
            "alley":$("#alleyForOrder").val() ,
            "houseNumber": $("#houseNumberForOrder").val() ,
        }
        if(json.proposedPrice < value.split(' ')[1]){
            Swal.fire({
                title: 'خطا!',
                text: 'قیمت پیشنهادی باید از حداقل مشخص شده بیشتر باشد',
                confirmButtonText: 'Cool',
                didOpen: function () {
                    Swal.showLoading()
                    setTimeout(function () {
                        Swal.close()
                    }, 2000)
                }
            })
            return;
        }


        $.ajax({
            url: "http://localhost:8080/order/placeAnOrder/" + subServicesId,
            data:JSON.stringify(json),
            type: "POST",
            dataType: 'text',
            contentType: 'application/json',
        }).done(function(msg) {
            if(msg === "OK") {
                $(':input','#placeAnOrder')
                    .not(':button, :submit, :reset, :hidden')
                    .val('')
                    .removeAttr('checked')
                    .removeAttr('selected');
                Swal.fire({
                    title: 'ثبت موفق!',
                    confirmButtonText: 'Cool',
                    didOpen: function () {
                        Swal.showLoading()
                        setTimeout(function () {
                            Swal.close()
                        }, 3000)
                    }
                })
            }
            else
                alert(msg)
        })
            .error(function (request){
            Swal.fire({
                title: 'خطا!',
                text: request.responseText,
                confirmButtonText: 'Cool',
                didOpen: function () {
                    Swal.showLoading()
                    setTimeout(function () {
                        Swal.close()
                    }, 2000)
                }
            })
        })
    });

    $("#showOfferButton").one('click',function() {
        $.ajax({
            url: "http://localhost:8080/order/viewExpertSelectionOrder",
            type: "GET",
            dataType: "json",
            success: function (response)
            {
                if(response.length === 0){
                    alert("شما هیچ سفارشی در وضعیت انتخاب پیشنهاد ندارید!")
                    return;
                }
                $("#TableOrderRowForCustomer").find("tr:gt(0)").remove();
                for(let i = 0; i < response.length; i++) {
                    $('#TableOrderRowForCustomer').append('<tr><td>' + response[i]['id'] +
                        '</td><td>' + response[i]['proposedPrice']  +
                        '</td><td>' + response[i]['description']  +
                        '</td><td>' + response[i]['date'].split('T')[0] +
                        '</td><td>' + response[i]['street'] +
                        '</td><td>' + '<button  data-id="' + response[i]['id'] + '" class="btn btn-warning btnSelectAnOffer" >انتخاب</button>');
                }
            },fail:(function (request){
                Swal.fire({
                    title: 'خطا!',
                    text: request.responseText,
                    didOpen: function () {
                        Swal.showLoading()
                        setTimeout(function () {
                            Swal.close()
                        }, 2000)
                    }
                })
            }),error:(function (request){
                Swal.fire({
                    title: 'خطا!',
                    text: request.responseText,
                    didOpen: function () {
                        Swal.showLoading()
                        setTimeout(function () {
                            Swal.close()
                        }, 2000)
                    }
                })
            })
        });
    });

    $('#TableOrderRowForCustomer').on('click','.btnSelectAnOffer',function(){
        let idVal=$(this).data('id');
        $.ajax({
            url: "http://localhost:8080/offer/viewOffer/" + idVal,
            type: "GET",
            dataType: "json",
            success: function (response)
            {
                if(response.length === 0){
                    alert("متاسفانه هیچ پیشنهادی ثبت شده است!")
                    return;
                }
                $("#TableOfferRowForCustomer").find("tr:gt(0)").remove();
                for(let i = 0; i < response.length; i++) {
                    $('#TableOfferRowForCustomer').append('<tr><td>' + response[i]['id'] +
                        '</td><td>' + response[i]['proposedPrice']  +
                        '</td><td>' + response[i]['durationWork']  +
                        '</td><td>' + response[i]['startTime'] +
                        '</td><td>' + '<button  data-id="' + response[i]['id'] + "," + idVal + '" class="btn btn-warning btnFinalSelectAnOffer" >انتخاب</button>');
                }
                $("#modalSelectAnOffer").show();
            },fail:(function (request){
                Swal.fire({
                    title: 'خطا!',
                    text: request.responseText,
                    didOpen: function () {
                        Swal.showLoading()
                        setTimeout(function () {
                            Swal.close()
                        }, 2000)
                    }
                })
            }),error:(function (request){
                Swal.fire({
                    title: 'خطا!',
                    text: request.responseText,
                    didOpen: function () {
                        Swal.showLoading()
                        setTimeout(function () {
                            Swal.close()
                        }, 2000)
                    }
                })
            })
        });
    });

    $('#closeModalSelectAnOffer').on('click',function (){
        $("#modalSelectAnOffer").hide();
        $("#TableOfferRowForCustomer").reload();
        location.reload(true);
    })

    $('#TableOfferRowForCustomer').on('click','.btnFinalSelectAnOffer',function() {
        let idVal = $(this).data('id');
        let offerId = idVal.split(',')[0];
        let orderId = idVal.split(',')[1];
        $.ajax({
            url: "http://localhost:8080/offer/selectOffer/" + orderId + "/" + offerId,
            type: "GET",
            dataType: "text",
            success: function (response) {
                if(response === 'OK'){
                    Swal.fire({
                        title: 'ثبت موفق',
                        didOpen: function () {
                            Swal.showLoading()
                            setTimeout(function () {
                                Swal.close()
                            }, 2000)
                        }
                    })
                    location.reload(true);
                }
            },fail:(function (request){
                Swal.fire({
                    title: 'خطا!',
                    text: request.responseText,
                    didOpen: function () {
                        Swal.showLoading()
                        setTimeout(function () {
                            Swal.close()
                        }, 2000)
                    }
                })
            }),error:(function (request){
                Swal.fire({
                    title: 'خطا!',
                    text: request.responseText,
                    didOpen: function () {
                        Swal.showLoading()
                        setTimeout(function () {
                            Swal.close()
                        }, 2000)
                    }
                })
            })
        });
    });

    $("#showStartedOrderButton").one('click',function() {
        $.ajax({
            url: "http://localhost:8080/order/viewOrderForDone",
            type: "GET",
            dataType: "json",
            success: function (response)
            {
                if(response.length === 0){
                    alert("شما هیچ سفارشی در وضعیت شروع شده ندارید!")
                    return;
                }
                $("#TableStartedOrderRowForCustomer").find("tr:gt(0)").remove();
                for(let i = 0; i < response.length; i++) {
                    $('#TableStartedOrderRowForCustomer').append('<tr><td>' + response[i]['id'] +
                        '</td><td>' + response[i]['proposedPrice']  +
                        '</td><td>' + response[i]['description']  +
                        '</td><td>' + response[i]['date'].split('T')[0] +
                        '</td><td>' + response[i]['street'] +
                        '</td><td>' + '<button  data-id="' + response[i]['id'] + '" class="btn btn-warning btnSelectAnOrderForPaid" >انتخاب</button>');
                }
            },fail:(function (request){
                Swal.fire({
                    title: 'خطا!',
                    text: request.responseText,
                    didOpen: function () {
                        Swal.showLoading()
                        setTimeout(function () {
                            Swal.close()
                        }, 2000)
                    }
                })
            }),error:(function (request){
                Swal.fire({
                    title: 'خطا!',
                    text: request.responseText,
                    didOpen: function () {
                        Swal.showLoading()
                        setTimeout(function () {
                            Swal.close()
                        }, 2000)
                    }
                })
            })
        });
    });

    $('#TableStartedOrderRowForCustomer').on('click','.btnSelectAnOrderForPaid',function() {
        let idVal = $(this).data('id');
        $.ajax({
            url: "http://localhost:8080/order/doneOrder/" + idVal,
            type: "GET",
            dataType: "text",
            success: function (response) {
                if(response === 'OK'){
                    Swal.fire({
                        title: 'ثبت موفق',
                        didOpen: function () {
                            Swal.showLoading()
                            setTimeout(function () {
                                Swal.close()
                            }, 2000)
                        }
                    })
                    location.reload(true);
                }else{
                    Swal.fire({
                        title:"ثبت موفق!",
                        text: response,
                        confirmButtonText:'بستن'
                    })
                    setInterval(function() {
                        location.reload();
                    },10000);
                }
            },fail:(function (request){
                Swal.fire({
                    title: 'خطا!',
                    text: request,
                    didOpen: function () {
                        Swal.showLoading()
                        setTimeout(function () {
                            Swal.close()
                        }, 5000)
                    }
                })
            }),error:(function (request){
                Swal.fire({
                    title: 'خطا!',
                    text: request.responseText,
                    didOpen: function () {
                        Swal.showLoading()
                        setTimeout(function () {
                            Swal.close()
                        }, 2000)
                    }
                })
            })
        });
    });

    $("#OrderForPayButton").one('click',function() {
        let price ;
        $.ajax({
            url: "http://localhost:8080/order/viewOrderForPaid",
            type: "GET",
            dataType: "json",
            success: function (response)
            {
                if(response.length === 0){
                    alert("شما هیچ سفارشی در وضعیت قابل پرداخت ندارید!")
                    return;
                }
                $("#TableOrderRowForPay").find("tr:gt(0)").remove();
                for(let i = 0; i < response.length; i++) {
                    $.ajax({
                        url:"http://localhost:8080/offer/priceWithOrderId/" + response[i]['id'],
                        type:'GET',
                        dataType:'text',
                        success:function (orderResponse){
                            $("#price").val(orderResponse);
                        }
                    })
                    alert(price)
                    $("#price").val(function(index, curValue){
                        price = curValue;
                    })
                    $('#TableOrderRowForPay').append('<tr><td>' + response[i]['id'] +
                        '</td><td>' + price +
                        '</td><td>' + response[i]['description']  +
                        '</td><td>' + response[i]['date'].split('T')[0] +
                        '</td><td>' + response[i]['street'] +
                        '</td><td>' + '<button  data-id="' + response[i]['id'] + '" class="btn btn-success btnSelectAnOrderForAccountPaid" >انتخاب</button>' +
                        '</td><td>' + '<button  data-id="' + response[i]['id'] + "," + price + '" class="btn btn-info btnSelectAnOrderForOnlinePaid" >انتخاب</button>');
                }
            },fail:(function (request){
                Swal.fire({
                    title: 'خطا!',
                    text: request.responseText,
                    didOpen: function () {
                        Swal.showLoading()
                        setTimeout(function () {
                            Swal.close()
                        }, 2000)
                    }
                })
            }),error:(function (request){
                Swal.fire({
                    title: 'خطا!',
                    text: request.responseText,
                    didOpen: function () {
                        Swal.showLoading()
                        setTimeout(function () {
                            Swal.close()
                        }, 2000)
                    }
                })
            })
        });
    });

    $('#TableOrderRowForPay').on('click','.btnSelectAnOrderForAccountPaid',function() {
        let idVal = $(this).data('id');
        $.ajax({
            url: "http://localhost:8080/order/PaidOrder/" + idVal,
            type: "GET",
            dataType: "text",
            success: function (response) {
                if(response === 'OK') {
                    Swal.fire({
                        title: 'ثبت موفق',
                        didOpen: function () {
                            Swal.showLoading()
                            setTimeout(function () {
                                Swal.close()
                            }, 3000)
                        }
                    })
                    setInterval(function () {
                        location.reload();
                    }, 3000);
                }
            },fail:(function (request){
                Swal.fire({
                    title: 'خطا!',
                    text: request,
                    didOpen: function () {
                        Swal.showLoading()
                        setTimeout(function () {
                            Swal.close()
                        }, 5000)
                    }
                })
            }),error:(function (request){
                Swal.fire({
                    title: 'خطا!',
                    text: request.responseText,
                    didOpen: function () {
                        Swal.showLoading()
                        setTimeout(function () {
                            Swal.close()
                        }, 2000)
                    }
                })
            })
        });
    });

    $('#TableOrderRowForPay').on('click', '.btnSelectAnOrderForOnlinePaid', function () {
        let idVal = $(this).data('id');
        let orderId = idVal.split(',')[0];
        let price = idVal.split(',')[1];
        window.open('payment.html?orderId='+orderId+'&&price='+price);
        location.reload(true);
    });

    $("#placeACommentButton").one('click',function() {
        let price ;
        $.ajax({
            url: "http://localhost:8080/order/viewPaidOrder",
            type: "GET",
            dataType: "json",
            success: function (response)
            {
                $("#TableOrderRowForComment").find("tr:gt(0)").remove();
                for(let i = 0; i < response.length; i++) {
                    $('#TableOrderRowForComment').append('<tr><td>' + response[i]['id'] +
                        '</td><td>' + response[i]['proposedPrice'] +
                        '</td><td>' + response[i]['description'] +
                        '</td><td>' + response[i]['date'].split('T')[0] +
                        '</td><td>' + response[i]['street'] +
                        '</td><td>' + '<button  data-id="' + response[i]['id'] + '" class="btn btn-info btnSelectAnOrderForComment" >انتخاب</button>');
                }
            },fail:(function (request){
                Swal.fire({
                    title: 'خطا!',
                    text: request.responseText,
                    didOpen: function () {
                        Swal.showLoading()
                        setTimeout(function () {
                            Swal.close()
                        }, 2000)
                    }
                })
            }),error:(function (request){
                Swal.fire({
                    title: 'خطا!',
                    text: request.responseText,
                    didOpen: function () {
                        Swal.showLoading()
                        setTimeout(function () {
                            Swal.close()
                        }, 2000)
                    }
                })
            })
        });
    });

    $('#TableOrderRowForComment').on('click', '.btnSelectAnOrderForComment', function () {
        let idVal = $(this).data('id');
        $("#orderIdInputComment").val(idVal);
        $("#modalPlaceAComment").show();
    });

    $('#closeModalPlaceAComment').on('click',function (){
        $(':input', '#modalPlaceAComment')
            .not(':button, :submit, :reset, :hidden ')
            .val('')
            .removeAttr('checked')
            .removeAttr('selected');
        $("#modalPlaceAComment").hide();
    })

    $("#submitPlaceACommentButton").on('click',function (){
        const orderId = $("#orderIdInputComment").val();
        const stars = $("#stars").val();
        const comment = $("#textCommentInput").val();
        let json = {
            "stars":stars,
            "comment":comment
        }
        $.ajax({
            url: "http://localhost:8080/comment/save/" + orderId,
            data:JSON.stringify(json),
            type: "POST",
            dataType: 'text',
            contentType: 'application/json',
        }).done(function(msg) {
            if(msg === "OK") {
                $(':input', '#modalPlaceAComment')
                    .not(':button, :submit, :reset, :hidden ')
                    .val('')
                    .removeAttr('checked')
                    .removeAttr('selected');
                Swal.fire({
                    title: 'ثبت موفق!',
                    confirmButtonText: 'Cool',
                    didOpen: function () {
                        Swal.showLoading()
                        setTimeout(function () {
                            Swal.close()
                        }, 3000)
                    }
                })
            }
        })
            .error(function (request){
                Swal.fire({
                    title: 'خطا!',
                    text: request.responseText,
                    confirmButtonText: 'Cool',
                    didOpen: function () {
                        Swal.showLoading()
                        setTimeout(function () {
                            Swal.close()
                        }, 2000)
                    }
                })
            })
    })



</script>
</body>
</html>