<!doctype html>
<html dir="rtl" lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="bootstrap/bootstrap.min.css" crossorigin="anonymous">
    <script src="https://kit.fontawesome.com/7c906e4b4a.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="./panelPage/customer/Customer.css">
</head>
<body>

<nav class="navbar navbar-expand-lg flex-column navbar-light trans ">
    <div class="container">
        <i class="fas fa-user-edit fa-5x text-warning" ></i>
        <div class="row align-content-start">
            <div >
                <a href="http://localhost:8080/logout" class="fas fa-sign-out-alt fa-3x text-warning"></a>
            </div>
        </div>
    </div>
</nav>

<div class="tab float-right ">
    <button class="tabLinks btn btn-block py-4 text-center w-100" onclick="openDiv(event, 'select')" id="defaultOpen">گزینه ها</button>
    <button class="tabLinks btn btn-block py-4 text-center w-100" onclick="openDiv(event, 'placeAnOrder')"  >ثبت سفارش</button>
    <button id="showOfferButton" class="tabLinks btn btn-block py-4 text-center w-100" onclick="openDiv(event, 'viewOffer')">مشاهده پیشنهادات</button>
    <button class="tabLinks btn btn-block py-4 text-center w-100" onclick="openDiv(event, 'doneOrder')">گزارش اتمام سفارش</button>
    <button class="tabLinks btn btn-block py-4 text-center w-100" onclick="openDiv(event, 'payOrder')">پرداخت هزینه سفارش</button>
    <button class="tabLinks btn btn-block py-4 text-center w-100" onclick="openDiv(event, 'placeAComment')">ثبت نظر</button>
    <button class="tabLinks btn btn-block py-4 text-center w-100" onclick="openDiv(event, 'orderHistory')">تاریخچه سفارشات</button>
    <button class="tabLinks btn btn-block py-4 text-center w-100" onclick="openDiv(event, 'changePassword')">تعویض رمز</button>
</div>

<!------>
<div id="select" class="tabContent text-center " style="font-size: 30px">
    <h1 class="mt-5">پنل مشتری</h1>
    <p>به پنل مشتری خوش آمدید</p>
</div>

<!------>
<div id="placeAnOrder" class="tabContent text-center " style="font-size: 20px">

    <div>
        <label for="placeAnOrderService">
            <select id="placeAnOrderService" name="placeAnOrder" class="form-select ml-5 w-100 ">
                <option class="text-center ">لطفا سرویس را انتخاب کنید</option>
            </select>
        </label>
        <label for="placeAnOrderSubService">
            <select id="placeAnOrderSubService" name="placeAnOrder" class="form-select mr-5 w-100 form-select-lg  mt-5">
                <option class="text-center ">لطفا زیر سرویس را انتخاب کنید</option>
            </select>
        </label>
    </div>
    <div>
        <label for="proposedPriceForOrder"><br>
            <input class="rounded-pill border-0 p-lg-5 " id="proposedPriceForOrder" pattern="^[0-9]" name="minimalPrice"
                   title="enter positive number" type="text" placeholder="قیمت پیشنهادی" required><br>
        </label>
        <label for="descriptionForOrder"><br>
            <input class="rounded-pill mr-5 border-0 p-lg-5 " id="descriptionForOrder" name="descriptionForOrder"
                   title="enter a correct description" type="text" placeholder="توضیحات" required><br>
        </label>
    </div>
    <div>
        <label for="workDateForOrder"><br>
            <input class="rounded-pill border-0 p-lg-5 " id="workDateForOrder" name="workDataForOrder" type="date"
                   placeholder="تاریخ انجام کار" required><br>
        </label>
        <label for="cityForOrder"><br>
            <input style="margin-left: -10px;margin-right: 200px" class="rounded-pill border-0 p-lg-5 " id="cityForOrder" name="cityForOrder"
                   title="enter city for your order" type="text" placeholder="شهر" required><br>
        </label>
    </div>
    <div>
        <label for="streetForOrder"><br>
            <input class="rounded-pill border-0 p-lg-5 " id="streetForOrder" name="streetForOrder"
                   title="enter street for your order" type="text" placeholder="خیابان"><br>
        </label>
        <label for="alleyForOrder"><br>
            <input class="rounded-pill mr-5 border-0 p-lg-5 " id="alleyForOrder" name="alleyForOrder"
                   title="enter alley for your order" type="text" placeholder="کوچه" required><br>
        </label>
    </div>
    <label>
        <input type="text" id="subServicesId" hidden>
    </label>
    <div>
        <label for="houseNumberForOrder"><br>
            <input style="margin-right: -450px" class="rounded-pill border-0 p-lg-5 " id="houseNumberForOrder" pattern="^[0-9]"
                   title="enter house number for your order" type="text" placeholder="شماره" required><br>
        </label>

        <button class=" mr-5 rounded-pill btn btn-info p-lg-5 font-italic font-weight-bold submit"
                id="submitPlaceAnOrder">ثبت
        </button>
    </div>
</div>
<!------>
<div id="viewOffer" class="tabContent text-center " style="font-size: 30px">
    <table id="tableOrderForCustomer" class="table container table-bordered border-primary">
        <thead>
        <tr>
            <th>شناسه</th>
            <th>قیمت پیشنهادی</th>
            <th>توضیح</th>
            <th>تاریخ</th>
            <th>آدرس</th>
            <th >انتخاب</th>
        </tr>
        </thead>
        <tbody id="TableOrderRowForCustomer">
        </tbody>
    </table>
    <div class="modal" id="modalSelectAnOffer" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content ">
                <div class="modal-header ">
                    <h4 class="modal-title text-center " id="myModalLabel">لطفا پیشنهاد مورد قبول خود را انتخاب کنید</h4>
                </div>
                <div class="modal-body">
                    <table id="tableOfferForCustomer" class="table container table-bordered border-primary">
                        <thead>
                        <tr>
                            <th>شناسه</th>
                            <th>قیمت پیشنهادی</th>
                            <th>مدت زمان تقریبی</th>
                            <th>ساعت شروع</th>
                            <th >انتخاب</th>
                        </tr>
                        </thead>
                        <tbody id="TableOfferRowForCustomer">
                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" id="closeModalSelectAnOffer" class="btn btn-default btn-danger" data-dismiss="modal">بستن</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!------>
<div id="doneOrder" class="tabContent text-center " style="font-size: 30px">
</div>
<!------>
<div id="payOrder" class="tabContent text-center " style="font-size: 30px">
</div>
<!------>
<div id="placeAComment" class="tabContent text-center " style="font-size: 30px">
</div>
<!------>
<div id="orderHistory" class="tabContent text-center " style="font-size: 30px">
</div>
<!------>
<div id="changePassword" class="tabContent text-center " style="font-size: 30px">
</div>
<!------>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script>

    function openDiv(evt, divName) {
        let i, tabContent, tabLinks;
        tabContent = document.getElementsByClassName("tabContent");
        for (i = 0; i < tabContent.length; i++) {
            tabContent[i].style.display = "none";
        }
        tabLinks = document.getElementsByClassName("tabLinks");
        for (i = 0; i < tabLinks.length; i++) {
            tabLinks[i].className = tabLinks[i].className.replace(" active", "");
        }
        document.getElementById(divName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    $("#placeAnOrderService").one('click', function () {
        $.ajax({
            url: "http://localhost:8080/services/getAllServices",
            type: "GET",
            dataType: "json",
            success: function (result) {
                let toAppend = '';
                $.each(result, function (i, o) {
                    toAppend += '<option>' + o.id + " " + o.services + '</option>';
                });
                $('#placeAnOrderService').append(toAppend);

                $("#placeAnOrderService").change(function () {
                    $('#placeAnOrderSubService')
                        .find('option')
                        .remove()
                        .end()
                        .append('<option >لطفا زیر سرویس را انتخاب کنید</option>')
                    if ($(this).val() !== "یک سرویس انتخاب کنید") {
                        $.ajax({
                            url: "http://localhost:8080/subServices/getAllSubServices/" + $(this).val()[0],
                            type: "GET",
                            dataType: "json",
                            success: function (result) {
                                let toAppend = '';
                                $.each(result, function (i, o) {
                                    toAppend += '<option>' + o.id + " " + o.subServicesName + " " + o.minimalPrice + '</option>';
                                });
                                $('#placeAnOrderSubService').append(toAppend);

                                $("#placeAnOrderSubService").change(function () {
                                    if ($(this).val() !== "لطفا زیر سرویس را انتخاب کنید") {
                                        $("#proposedPriceForOrder").attr("placeholder", "حداقل قیمت پیشنهادی " + $(this).val().split(' ')[2]);
                                        $("#subServicesId").val($(this).val()[0] + " " + $(this).val().split(' ')[2] )
                                    }
                                });
                            }
                        });
                    }
                });
            },
        });
    });

    $("#submitPlaceAnOrder").on('click',function() {
        let value = $("#subServicesId").val();
        let subServicesId = value.split(' ')[0];
        if(subServicesId === ""){
            Swal.fire({
                title: 'لطفا یک سرویس انتخاب کنید',
                confirmButtonText: 'بستن',
            });
            return;
        }
        let json = {
            "id":subServicesId,
            "proposedPrice":$("#proposedPriceForOrder").val() ,
            "description":$("#descriptionForOrder").val() ,
            "date":$("#workDateForOrder").val() ,
            "city":$("#cityForOrder").val() ,
            "street":$("#streetForOrder").val() ,
            "alley":$("#alleyForOrder").val() ,
            "houseNumber": $("#houseNumberForOrder").val() ,
        }
        if(json.proposedPrice < value.split(' ')[1]){
            Swal.fire({
                title: 'خطا!',
                text: 'قیمت پیشنهادی باید از حداقل مشخص شده بیشتر باشد',
                confirmButtonText: 'Cool',
                didOpen: function () {
                    Swal.showLoading()
                    setTimeout(function () {
                        Swal.close()
                    }, 2000)
                }
            })
            return;
        }


        $.ajax({
            url: "http://localhost:8080/order/placeAnOrder/" + subServicesId,
            data:JSON.stringify(json),
            type: "POST",
            dataType: 'text',
            contentType: 'application/json',
        }).done(function(msg) {
            if(msg === "OK") {
                $(':input','#placeAnOrder')
                    .not(':button, :submit, :reset, :hidden')
                    .val('')
                    .removeAttr('checked')
                    .removeAttr('selected');
                Swal.fire({
                    title: 'ثبت موفق!',
                    confirmButtonText: 'Cool',
                    didOpen: function () {
                        Swal.showLoading()
                        setTimeout(function () {
                            Swal.close()
                        }, 3000)
                    }
                })
            }
            else
                alert(msg)
        })
            .error(function (request){
            Swal.fire({
                title: 'خطا!',
                text: request.responseText,
                confirmButtonText: 'Cool',
                didOpen: function () {
                    Swal.showLoading()
                    setTimeout(function () {
                        Swal.close()
                    }, 2000)
                }
            })
        })
    });

    $("#showOfferButton").one('click',function() {
        $.ajax({
            url: "http://localhost:8080/order/viewExpertSelectionOrder",
            type: "GET",
            dataType: "json",
            success: function (response)
            {
                if(response.length === 0){
                    alert("شما هیچ سفارشی در وضعیت انتخاب پیشنهاد ندارید!")
                    return;
                }
                $("#TableOrderRowForCustomer").find("tr:gt(0)").remove();
                for(let i = 0; i < response.length; i++) {
                    $('#TableOrderRowForCustomer').append('<tr><td>' + response[i]['id'] +
                        '</td><td>' + response[i]['proposedPrice']  +
                        '</td><td>' + response[i]['description']  +
                        '</td><td>' + response[i]['date'].split('T')[0] +
                        '</td><td>' + response[i]['street'] +
                        '</td><td>' + '<button  data-id="' + response[i]['id'] + '" class="btn btn-warning btnSelectAnOffer" >انتخاب</button>');
                }
            },fail:(function (request){
                Swal.fire({
                    title: 'خطا!',
                    text: request.responseText,
                    didOpen: function () {
                        Swal.showLoading()
                        setTimeout(function () {
                            Swal.close()
                        }, 2000)
                    }
                })
            }),error:(function (request){
                Swal.fire({
                    title: 'خطا!',
                    text: request.responseText,
                    didOpen: function () {
                        Swal.showLoading()
                        setTimeout(function () {
                            Swal.close()
                        }, 2000)
                    }
                })
            })
        });
    });

    $('#TableOrderRowForCustomer').on('click','.btnSelectAnOffer',function(){
        let idVal=$(this).data('id');
        $.ajax({
            url: "http://localhost:8080/offer/viewOffer/" + idVal,
            type: "GET",
            dataType: "json",
            success: function (response)
            {
                if(response.length === 0){
                    alert("متاسفانه هیچ پیشنهادی ثبت شده است!")
                    return;
                }
                $("#TableOfferRowForCustomer").find("tr:gt(0)").remove();
                for(let i = 0; i < response.length; i++) {
                    $('#TableOfferRowForCustomer').append('<tr><td>' + response[i]['id'] +
                        '</td><td>' + response[i]['proposedPrice']  +
                        '</td><td>' + response[i]['durationWork']  +
                        '</td><td>' + response[i]['startTime'] +
                        '</td><td>' + '<button  data-id="' + response[i]['id'] + "," + idVal + '" class="btn btn-warning btnFinalSelectAnOffer" >انتخاب</button>');
                }
                $("#modalSelectAnOffer").show();
            },fail:(function (request){
                Swal.fire({
                    title: 'خطا!',
                    text: request.responseText,
                    didOpen: function () {
                        Swal.showLoading()
                        setTimeout(function () {
                            Swal.close()
                        }, 2000)
                    }
                })
            }),error:(function (request){
                Swal.fire({
                    title: 'خطا!',
                    text: request.responseText,
                    didOpen: function () {
                        Swal.showLoading()
                        setTimeout(function () {
                            Swal.close()
                        }, 2000)
                    }
                })
            })
        });
    });

    $('#closeModalSelectAnOffer').on('click',function (){
        $("#modalSelectAnOffer").hide();
        $("#TableOfferRowForCustomer").reload();
        location.reload(true);
    })

    $('#TableOfferRowForCustomer').on('click','.btnFinalSelectAnOffer',function() {
        let idVal = $(this).data('id');
        let offerId = idVal.split(',')[0];
        let orderId = idVal.split(',')[1];
        alert(offerId)
        alert(orderId)
        /*
        $.ajax({
            url: "http://localhost:8080/offer/viewOffer/" + idVal,
            type: "GET",
            dataType: "text",
            success: function (response)
            {
                if(response.length === 0){
                    alert("متاسفانه هیچ پیشنهادی ثبت شده است!")
                    return;
                }
                $("#TableOfferRowForCustomer").find("tr:gt(0)").remove();
                for(let i = 0; i < response.length; i++) {
                    $('#TableOfferRowForCustomer').append('<tr><td>' + response[i]['id'] +
                        '</td><td>' + response[i]['proposedPrice']  +
                        '</td><td>' + response[i]['durationWork']  +
                        '</td><td>' + response[i]['startTime'] +
                        '</td><td>' + '<button  data-id="' + response[i]['id'] + "," + idVal + '" class="btn btn-warning btnFinalSelectAnOffer" >انتخاب</button>');
                }
                $("#modalSelectAnOffer").show();
            },fail:(function (request){
                Swal.fire({
                    title: 'خطا!',
                    text: request.responseText,
                    didOpen: function () {
                        Swal.showLoading()
                        setTimeout(function () {
                            Swal.close()
                        }, 2000)
                    }
                })
            }),error:(function (request){
                Swal.fire({
                    title: 'خطا!',
                    text: request.responseText,
                    didOpen: function () {
                        Swal.showLoading()
                        setTimeout(function () {
                            Swal.close()
                        }, 2000)
                    }
                })
            })
        });

         */
    });



</script>
</body>
</html>